# Drizzle ORM ÏÇ¨Ïö©Î≤ï

DrizzleÏùÄ TypeScriptÎ•º ÏúÑÌïú Í≤ΩÎüâ ORMÏúºÎ°ú, ÌÉÄÏûÖ ÏïàÏ†ÑÏÑ±Í≥º ÏÑ±Îä•Ïóê Ï§ëÏ†êÏùÑ Îëî Î™®Îçò Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ìà¥ÏûÖÎãàÎã§.

---

## üì¶ ÏÑ§Ïπò

```bash
# ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
npm install drizzle-orm pg

# Í∞úÎ∞ú ÏùòÏ°¥ÏÑ±
npm install -D drizzle-kit @types/pg
```

---

## üóÇÔ∏è ÌîÑÎ°úÏ†ùÌä∏ Íµ¨Ï°∞

```
problem-bank-server/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ drizzle/
‚îÇ       ‚îú‚îÄ‚îÄ schema.ts           # Ïä§ÌÇ§Îßà Ï†ïÏùò
‚îÇ       ‚îú‚îÄ‚îÄ drizzle.module.ts   # NestJS Î™®Îìà
‚îÇ       ‚îî‚îÄ‚îÄ migrations/         # ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÌååÏùºÎì§
‚îú‚îÄ‚îÄ drizzle.config.ts           # Drizzle ÏÑ§Ï†ï
‚îî‚îÄ‚îÄ package.json
```

---

## üéØ 1. Ïä§ÌÇ§Îßà Ï†ïÏùò (`schema.ts`)

### Í∏∞Î≥∏ ÌÖåÏù¥Î∏î Ï†ïÏùò

```typescript
import { pgTable, serial, varchar, text, timestamp } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  name: varchar('name', { length: 100 }).notNull(),
  email: varchar('email', { length: 255 }).notNull().unique(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});
```

### Enum Ï†ïÏùò

```typescript
import { pgEnum } from 'drizzle-orm/pg-core';

export const difficultyEnum = pgEnum('difficulty', ['EASY', 'MEDIUM', 'HARD']);

export const problems = pgTable('problems', {
  id: serial('id').primaryKey(),
  difficulty: difficultyEnum('difficulty').notNull(),
  // ...
});
```

### Ïô∏ÎûòÌÇ§ Í¥ÄÍ≥Ñ

```typescript
import { integer } from 'drizzle-orm/pg-core';

export const problems = pgTable('problems', {
  id: serial('id').primaryKey(),
  categoryId: integer('category_id')
    .references(() => categories.id)
    .notNull(),
});
```

### Ï†ÑÏ≤¥ Ïª¨Îüº ÌÉÄÏûÖ

```typescript
import {
  serial,      // SERIAL (ÏûêÎèô Ï¶ùÍ∞Ä ID)
  integer,     // INTEGER
  varchar,     // VARCHAR
  text,        // TEXT
  boolean,     // BOOLEAN
  timestamp,   // TIMESTAMP
  date,        // DATE
  json,        // JSON
  jsonb,       // JSONB
} from 'drizzle-orm/pg-core';
```

---

## ‚öôÔ∏è 2. Drizzle ÏÑ§Ï†ï (`drizzle.config.ts`)

```typescript
import type { Config } from 'drizzle-kit';

export default {
  schema: './src/drizzle/schema.ts',
  out: './src/drizzle/migrations',
  dialect: 'postgresql',
  dbCredentials: {
    host: 'localhost',
    port: 5433,
    user: 'user',
    password: 'password',
    database: 'problem-bank',
    ssl: false,
  },
} satisfies Config;
```

---

## üîå 3. NestJS Ïó∞Îèô (`drizzle.module.ts`)

```typescript
import { Module } from '@nestjs/common';
import { Pool } from 'pg';
import { drizzle, NodePgDatabase } from 'drizzle-orm/node-postgres';
import * as schema from './schema';

export const DRIZZLE_ORM = Symbol('DRIZZLE_ORM');

@Module({
  providers: [
    {
      provide: DRIZZLE_ORM,
      useFactory: async (): Promise<NodePgDatabase<typeof schema>> => {
        const pool = new Pool({
          host: 'localhost',
          port: 5433,
          user: 'user',
          password: 'password',
          database: 'problem-bank',
        });

        return drizzle(pool, { schema });
      },
    },
  ],
  exports: [DRIZZLE_ORM],
})
export class DrizzleModule {}
```

---

## üöÄ 4. ServiceÏóêÏÑú ÏÇ¨Ïö©ÌïòÍ∏∞

```typescript
import { Inject, Injectable } from '@nestjs/common';
import { NodePgDatabase } from 'drizzle-orm/node-postgres';
import { eq, and, or, gt, lt, like } from 'drizzle-orm';
import * as schema from '../drizzle/schema';
import { DRIZZLE_ORM } from '../drizzle/drizzle.module';

@Injectable()
export class ProblemsService {
  constructor(
    @Inject(DRIZZLE_ORM)
    private readonly db: NodePgDatabase<typeof schema>,
  ) {}

  // INSERT
  async create(data: any) {
    const [problem] = await this.db
      .insert(schema.problems)
      .values(data)
      .returning();
    return problem;
  }

  // SELECT ALL
  async findAll() {
    return await this.db.select().from(schema.problems);
  }

  // SELECT ONE
  async findOne(id: number) {
    const [problem] = await this.db
      .select()
      .from(schema.problems)
      .where(eq(schema.problems.id, id));
    return problem;
  }

  // UPDATE
  async update(id: number, data: any) {
    const [problem] = await this.db
      .update(schema.problems)
      .set(data)
      .where(eq(schema.problems.id, id))
      .returning();
    return problem;
  }

  // DELETE
  async remove(id: number) {
    await this.db
      .delete(schema.problems)
      .where(eq(schema.problems.id, id));
    return { deleted: true };
  }
}
```

---

## üìù 5. CRUD ÏøºÎ¶¨ ÏòàÏãú

### SELECT (Ï°∞Ìöå)

```typescript
// Ï†ÑÏ≤¥ Ï°∞Ìöå
const allProblems = await db.select().from(problems);

// ÌäπÏ†ï Ïª¨ÎüºÎßå Ï°∞Ìöå
const names = await db.select({ id: problems.id, name: problems.questionText })
  .from(problems);

// WHERE Ï°∞Í±¥
const easyProblems = await db.select()
  .from(problems)
  .where(eq(problems.difficulty, 'EASY'));

// Î≥µÌï© Ï°∞Í±¥
const filtered = await db.select()
  .from(problems)
  .where(
    and(
      eq(problems.difficulty, 'EASY'),
      eq(problems.isActive, true)
    )
  );

// OR Ï°∞Í±¥
const orFiltered = await db.select()
  .from(problems)
  .where(
    or(
      eq(problems.difficulty, 'EASY'),
      eq(problems.difficulty, 'MEDIUM')
    )
  );

// LIKE Í≤ÄÏÉâ
const searched = await db.select()
  .from(problems)
  .where(like(problems.questionText, '%ÏàòÌïô%'));

// Ï†ïÎ†¨
const sorted = await db.select()
  .from(problems)
  .orderBy(problems.createdAt);

// ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò
const paginated = await db.select()
  .from(problems)
  .limit(10)
  .offset(20);
```

### INSERT (ÏÉùÏÑ±)

```typescript
// Îã®Ïùº ÏÉùÏÑ±
const [newProblem] = await db.insert(problems)
  .values({
    categoryId: 1,
    questionType: 'MULTIPLE_CHOICE',
    difficulty: 'EASY',
    questionText: '2 + 2 = ?',
    correctAnswer: '4',
  })
  .returning();

// Ïó¨Îü¨ Í∞ú ÏÉùÏÑ±
const newProblems = await db.insert(problems)
  .values([
    { categoryId: 1, questionText: 'Q1', correctAnswer: 'A1' },
    { categoryId: 2, questionText: 'Q2', correctAnswer: 'A2' },
  ])
  .returning();
```

### UPDATE (ÏàòÏ†ï)

```typescript
// Îã®Ïùº ÏàòÏ†ï
const [updated] = await db.update(problems)
  .set({ difficulty: 'MEDIUM', explanation: 'ÏàòÏ†ïÎêú Ìï¥ÏÑ§' })
  .where(eq(problems.id, 1))
  .returning();

// Ïó¨Îü¨ Í∞ú ÏàòÏ†ï
await db.update(problems)
  .set({ isActive: false })
  .where(eq(problems.difficulty, 'EASY'));
```

### DELETE (ÏÇ≠Ï†ú)

```typescript
// Îã®Ïùº ÏÇ≠Ï†ú
await db.delete(problems)
  .where(eq(problems.id, 1));

// Ï°∞Í±¥Î∂Ä ÏÇ≠Ï†ú
await db.delete(problems)
  .where(eq(problems.isActive, false));
```

---

## üîó 6. JOIN ÏøºÎ¶¨

```typescript
// INNER JOIN
const problemsWithCategory = await db.select({
  problemId: problems.id,
  questionText: problems.questionText,
  categoryName: categories.name,
})
  .from(problems)
  .innerJoin(categories, eq(problems.categoryId, categories.id));

// LEFT JOIN
const allProblems = await db.select()
  .from(problems)
  .leftJoin(categories, eq(problems.categoryId, categories.id));
```

---

## üõ†Ô∏è 7. ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Î™ÖÎ†πÏñ¥

### package.json Ïä§ÌÅ¨Î¶ΩÌä∏

```json
{
  "scripts": {
    "db:generate": "drizzle-kit generate",
    "db:push": "drizzle-kit push",
    "db:studio": "drizzle-kit studio"
  }
}
```

### Î™ÖÎ†πÏñ¥ Ïã§Ìñâ

```bash
# 1. Ïä§ÌÇ§Îßà Î≥ÄÍ≤Ω ÌõÑ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÌååÏùº ÏÉùÏÑ±
npm run db:generate

# 2. Ïä§ÌÇ§ÎßàÎ•º DBÏóê ÏßÅÏ†ë Ï†ÅÏö© (Í∞úÎ∞úÏö©)
npm run db:push

# 3. Drizzle Studio GUI Ïã§Ìñâ
npm run db:studio
# ‚Üí http://localhost:4983 Ï†ëÏÜç
```

---

## üéØ 8. Í≥†Í∏â Í∏∞Îä•

### Ìä∏ÎûúÏû≠ÏÖò

```typescript
await db.transaction(async (tx) => {
  const [category] = await tx.insert(categories)
    .values({ name: 'ÏàòÌïô' })
    .returning();

  await tx.insert(problems)
    .values({
      categoryId: category.id,
      questionText: '1 + 1 = ?',
      correctAnswer: '2',
    });
});
```

### ÏßëÍ≥Ñ Ìï®Ïàò

```typescript
import { count, avg, sum } from 'drizzle-orm';

// COUNT
const totalProblems = await db.select({ count: count() })
  .from(problems);

// AVG
const avgScore = await db.select({ avg: avg(userAttempts.score) })
  .from(userAttempts);
```

### EXISTS

```typescript
import { exists } from 'drizzle-orm';

const hasProblems = await db.select()
  .from(categories)
  .where(
    exists(
      db.select().from(problems)
        .where(eq(problems.categoryId, categories.id))
    )
  );
```

---

## üö® 9. Ï£ºÏùòÏÇ¨Ìï≠

### ‚ùå ÌîºÌï¥Ïïº Ìï† Ìå®ÌÑ¥

```typescript
// ÏûòÎ™ªÎêú Î∞©Î≤ï: raw SQL ÏßÅÏ†ë ÏÇ¨Ïö©
const results = await db.execute('SELECT * FROM problems');

// Ïò¨Î∞îÎ•∏ Î∞©Î≤ï: Drizzle ÏøºÎ¶¨ ÎπåÎçî ÏÇ¨Ïö©
const results = await db.select().from(problems);
```

### ‚úÖ Í∂åÏû• Ìå®ÌÑ¥

```typescript
// ÌÉÄÏûÖ ÏïàÏ†ÑÌïú ÏøºÎ¶¨
const problem = await db.select()
  .from(problems)
  .where(eq(problems.id, id));

// returning()ÏúºÎ°ú ÏÉùÏÑ±/ÏàòÏ†ïÎêú Îç∞Ïù¥ÌÑ∞ Ï¶âÏãú Î∞òÌôò
const [newProblem] = await db.insert(problems)
  .values(data)
  .returning();
```

---

## üìö 10. Ïú†Ïö©Ìïú Ïó∞ÏÇ∞Ïûê

```typescript
import {
  eq,         // =
  ne,         // !=
  gt,         // >
  gte,        // >=
  lt,         // <
  lte,        // <=
  like,       // LIKE
  ilike,      // ILIKE (ÎåÄÏÜåÎ¨∏Ïûê Î¨¥Ïãú)
  inArray,    // IN
  notInArray, // NOT IN
  isNull,     // IS NULL
  isNotNull,  // IS NOT NULL
  and,        // AND
  or,         // OR
  not,        // NOT
} from 'drizzle-orm';

// ÏÇ¨Ïö© ÏòàÏãú
const filtered = await db.select()
  .from(problems)
  .where(
    and(
      gte(problems.id, 10),
      lt(problems.id, 100),
      inArray(problems.difficulty, ['EASY', 'MEDIUM']),
      isNotNull(problems.explanation)
    )
  );
```

---

## üéì ÌïôÏäµ Î¶¨ÏÜåÏä§

- **Í≥µÏãù Î¨∏ÏÑú**: https://orm.drizzle.team
- **GitHub**: https://github.com/drizzle-team/drizzle-orm
- **Drizzle Studio**: Î°úÏª¨ DB GUI ÎèÑÍµ¨

---

## üÜö Prisma vs Drizzle ÎπÑÍµê

| ÌäπÏßï              | Prisma                  | Drizzle                    |
|-------------------|-------------------------|----------------------------|
| ÌÉÄÏûÖ ÏïàÏ†ÑÏÑ±       | ÎÜíÏùå                    | Îß§Ïö∞ ÎÜíÏùå (SQL-like)       |
| Î≤àÎì§ ÌÅ¨Í∏∞         | ÌÅ¨Îã§ (~2MB)             | ÏûëÎã§ (~200KB)              |
| ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò      | Prisma Migrate          | Drizzle Kit (SQL ÌååÏùº)     |
| GUI ÎèÑÍµ¨          | Prisma Studio           | Drizzle Studio             |
| ÌïôÏäµ Í≥°ÏÑ†         | ÏôÑÎßåÌï®                  | ÏïΩÍ∞Ñ Í∞ÄÌååÎ¶Ñ (SQL ÏßÄÏãù ÌïÑÏöî) |
| ÏÑ±Îä•              | ÏñëÌò∏                    | Ïö∞Ïàò (Zero-cost)           |
| SQL Ï†úÏñ¥          | Ï†úÌïúÏ†Å                  | ÏôÑÏ†ÑÌïú Ï†úÏñ¥                |

---

## ‚úÖ ÌïµÏã¨ Ï†ïÎ¶¨

1. **Ïä§ÌÇ§Îßà Ï†ïÏùò** ‚Üí `schema.ts`ÏóêÏÑú ÌÉÄÏûÖ ÏïàÏ†ÑÌïòÍ≤å Ï†ïÏùò
2. **ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò** ‚Üí `npm run db:generate` ‚Üí `npm run db:push`
3. **NestJS Ïó∞Îèô** ‚Üí `DRIZZLE_ORM` Ïã¨Î≥ºÎ°ú Ï£ºÏûÖ
4. **ÏøºÎ¶¨ ÏûëÏÑ±** ‚Üí SQL-like APIÎ°ú ÏßÅÍ¥ÄÏ†Å ÏûëÏÑ±
5. **ÌÉÄÏûÖ ÏïàÏ†ÑÏÑ±** ‚Üí TypeScriptÏôÄ ÏôÑÎ≤ΩÌïú ÌÜµÌï©

**Drizzle = ÌÉÄÏûÖ ÏïàÏ†Ñ + Í≤ΩÎüâ + SQL Ï†úÏñ¥Î†•**
